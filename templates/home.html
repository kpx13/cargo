{% extends 'base.html' %}

{% block headjs %}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
{% endblock %}


{% block head_script %}
<script type="text/javascript">
    var directionsDisplay;
    var directionsService = new google.maps.DirectionsService();
    var map;
    var geocoder;
    var gl_start;
    var gl_end;
    var start;
    var end;

    jQuery(document).ready(function(){
        geocoder = new google.maps.Geocoder();
        directionsDisplay = new google.maps.DirectionsRenderer();
        var opts = {
          center: new google.maps.LatLng(55.53, 9.4),
          zoom: 10,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById('map'), opts);
        directionsDisplay.setMap(map);

        $('#calc_button').click(function(){
            calcRoute();
        });
    });

    function calcRoute() {
        gl_start = null;
        gl_end = null;

        $("#resultDistance").val("");


        var start = $("#start").val();
        geocoder.geocode( { 'address': start}, function(results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
            gl_start = results[0].geometry.location;
            checkArgs();
        }});


        var end = $("#end").val();
        geocoder.geocode( { 'address': end}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
            gl_end = results[0].geometry.location;
            checkArgs();
        }});
    }

    function checkArgs () {
        if (gl_start == null || gl_end == null) {
            return;
        }

        var waypts = [];

        var request = {
            origin: gl_start,
            destination: gl_end,
            waypoints: waypts,
            optimizeWaypoints: true,
            travelMode: google.maps.DirectionsTravelMode.DRIVING
        };
        directionsService.route(request, function(response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(response);
                var route = response.routes[0];
                var summaryPanel = document.getElementById("resultDistance");
                //summaryPanel.innerHTML = "";
        // For each route, display summary information.
                for (var i = 0; i < route.legs.length; i++) {
                    $("#resultDistance").val(route.legs[i].distance.text);
                }
            }
        });
    }

</script>
{% endblock %}


{% block content %}

<div id="map" style="display:none;"></div>

<div class="bl_l">
        <h1>{{title}}</h1>
        {{content|safe}}
      </div>

      <div class="bl_r">
        <div class="kalk lineForm">
          <h2>РАСЧЕТ<br /> РАССТОЯНИЯ</h2>
          <form action="#" method="post">
            <div class="w1">
              <label for="start">от</label>
              <input type="text" id="start" value="Москва"/>
            </div>
            <div class="w1">
              <label for="end">до</label>
              <input type="text" id="end" value="Рязань"/>
            </div>
            <div class="w1">
              <label>км</label>
              <input type="text" id="resultDistance" value="" class="inp" readonly=""/>
            </div>
            <div class="kn"><input type="button" id="calc_button" value="Посчитать" /></div>
          </form>
        </div>
      </div>
      
      
      <div class="bl_r" style='margin-top: 20px'>
        <div class="feedback_form lineForm">
          <h2>ОБРАТНАЯ<br />СВЯЗЬ</h2>
          <form method="post">
            {% csrf_token %}
            {{ feedback_form.as_p }}
            <div class="kn"><input type="submit" value="Отправить" /></div>
          </form>
        </div>
      </div>

      <div class="info">
        <ul>
          {% for r in rates %}
          <li>
            <a href="/rates/{{r.id}}">
              <span class="foto"><img src="/media/{{r.header_photo_min}}" alt="{{r.name}}" /></span>
              <span class="text">{{r.name}}</span>
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>

      <div class="nav">
        <ul>
          <li><a href="{% url static_page 'contacts' %}"><img src="/static/images/item1.png" alt="" class="item1" />Контакты</a></li>
          <li><a href="{% url order_page %}"><img src="/static/images/item2.png" alt="" class="item2" />Заказ онлайн</a></li>
          <li><a href="{% url feedback_page %}" class="st2"><img src="/static/images/item3.png" alt="" class="item3" />Качество обслуживания</a></li>
        </ul>
        <ul>
          <li><a href="{% url static_page 'rules' %}" class="st2"><img src="/static/images/item5.png" alt="" class="item5" />Правила и законы грузоперевозок</a></li>
          <li><a href="{% url static_page 'terminology' %}" class="st2"><img src="/static/images/item6.png" alt="" class="item6" />Терминология доставки</a></li>
          <li><a href="{% url static_page 'tips' %}"><img src="/static/images/item7.png" alt="" class="item7" />Полезные советы</a></li>
        </ul>
        <ul>
          <li></li>
          <li><a href="{% url static_page 'offers' %}" class="st2"><img src="/static/images/item9.png" alt="" class="item9" />Специальные предложения</a></li>
          <li></li>
        </ul>
      </div>


{% endblock %}
